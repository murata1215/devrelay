// DevRelay Database Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ユーザー
model User {
  id            String    @id @default(cuid())
  email         String?   @unique
  passwordHash  String?   // メール/パスワード認証用
  name          String?   // 表示名
  googleId      String?   @unique // Google OAuth 用
  apiKey        String?   // Anthropic API Key (encrypted)
  plan          String    @default("free") // free, pro, team
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  machines      Machine[]
  sessions      Session[]
  platformLinks PlatformLink[]
  settings      UserSettings[]
  authSessions  AuthSession[]
}

// WebUI 認証セッション
model AuthSession {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
}

// プラットフォーム連携
model PlatformLink {
  id                   String    @id @default(cuid())
  userId               String
  user                 User      @relation(fields: [userId], references: [id])
  platform             String    // discord, telegram, line, slack
  platformUserId       String    // プラットフォーム側のユーザーID
  platformName         String?   // プラットフォーム側のユーザー名（Discord username など）
  chatId               String?   // DMのチャットID
  lastProjectId        String?   // 前回接続したプロジェクト（継続用）
  lastMentionMessageId String?   // 前回メンションしたメッセージID（過去メッセージ取得用）
  lastMentionAt        DateTime? // 前回メンション日時
  linkedAt             DateTime? // リンクコードでリンクされた日時
  createdAt            DateTime  @default(now())

  @@unique([platform, platformUserId])
}

// プラットフォームリンクコード（一時的な認証コード）
model PlatformLinkCode {
  id             String   @id @default(cuid())
  code           String   @unique  // 6桁コード (例: ABC123)
  platform       String   // discord, telegram
  platformUserId String   // プラットフォーム側のユーザーID
  platformName   String?  // Discord username など
  chatId         String?  // 返信用チャットID
  expiresAt      DateTime // 5分後
  createdAt      DateTime @default(now())
}

// マシン
model Machine {
  id            String    @id @default(cuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id])
  name          String
  token         String    @unique // 接続トークン
  status        String    @default("offline") // online, offline
  lastSeenAt    DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  projects      Project[]
  sessions      Session[]
  
  @@unique([userId, name])
}

// プロジェクト
model Project {
  id          String    @id @default(cuid())
  machineId   String
  machine     Machine   @relation(fields: [machineId], references: [id])
  name        String
  path        String
  defaultAi   String    @default("claude")
  lastUsedAt  DateTime?
  createdAt   DateTime  @default(now())
  
  sessions    Session[]
  
  @@unique([machineId, name])
}

// セッション
model Session {
  id            String    @id @default(cuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id])
  machineId     String
  machine       Machine   @relation(fields: [machineId], references: [id])
  projectId     String
  project       Project   @relation(fields: [projectId], references: [id])
  aiTool        String    @default("claude")
  status        String    @default("active") // active, ended
  startedAt     DateTime  @default(now())
  endedAt       DateTime?
  
  messages      Message[]
}

// メッセージ履歴
model Message {
  id          String    @id @default(cuid())
  sessionId   String
  session     Session   @relation(fields: [sessionId], references: [id])
  role        String    // user, ai, system
  content     String
  platform    String    // どのプラットフォームから送信されたか
  createdAt   DateTime  @default(now())
}

// ユーザー設定（汎用的なKey-Value形式）
model UserSettings {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  key       String   // 設定キー（例: openai_api_key, theme, language など）
  value     String   // 設定値（暗号化が必要な場合は暗号化して保存）
  encrypted Boolean  @default(false) // 暗号化されているかどうか
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, key])
}

// チャンネルセッション（チャンネルごとの前回接続先を記録）
model ChannelSession {
  id               String    @id @default(cuid())
  platform         String    // discord, telegram, line
  chatId           String    // チャンネルID（Discord: channel.id, Telegram: chat.id, LINE: groupId/roomId/userId）
  lastProjectId    String?   // 前回接続したプロジェクトID
  currentSessionId String?   // 現在のセッションID（サーバー再起動後に復元用）
  currentMachineId String?   // 現在のマシンID（サーバー再起動後に復元用）
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@unique([platform, chatId])
}
